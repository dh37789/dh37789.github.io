---
title:  "[JPA] 양방향 연관관계 (2) - 양방향 매핑 주의사항"

categories: JPA

toc: true
toc_sticky: true

date: 2022-06-26
last_modified_at: 2022-06-26
---

# 양방향 매핑 주의사항

## 연관관계의 주인을 미입력시

예시

위의 예시를 실행했을때 insert SQL 쿼리가 날라갔음에도 데이터가 누락이 되어있음

mappedBy로 지정된 경우 읽기전용이라 엔티티데이터를 수정해도 update가 날아가지 않는다.

member에 team의 값을 넣어주지않아 생김

해당 이슈를 지양하기 위해서 연관관계인 두 Entity에 모두 데이터를 넣어주는것이 낫다.

한쪽만 데이터를 넣을 경우 한 트랜잭션 내에 인서트 쿼리가 닐라가지 않아 1차 캐시 내부에서 데이터를 조회해 오는데 해당 컬렉션의 데이터가 null이 들어가있을 수 있음

## 양방향 연관관계 주의
- 순수 객체상태를 고려해서 항상 양쪽에 값을 설정하자
- 연관관계 편의 메소드를 생성하자
- 양방매핑시 무한 루프를 조심하자
    - toString, lombok, JSON 라이브러리
    - lombok 에서 tostring 은 제외할것
    - entity를 controller에서 response로 반환하면 안된다 dto로 가공해서 반환할것

- 값을 셋팅할 주체는 둘중 한군데로 정해주면 된다 한군데에 둘다 값을 셋팅
- 예시

## 정리
- 단방향 매핑만으로도 이미 연관관계 매핑은 완료
- 양방향 매핑은 반대 방향으로 조회 (객체 그래프 탐색) 기능이 추가된 것 뿐
- JPQL에서 역방향으로 탐색할 일이 많다
- 양방향 매핑은 무조건 하는것이 아니라 단방향매핑을 달하고 꼭 필요할때 양방향매핑을 넣을것
- (테이블에 연관을 주지 않는다.)

## 연관관계의 주인을 정하는 기준
- 비지니스 로직을 기준으로 연관관계의 주인을 선택하면 안된다
- 연관관계 주인은 외래키의 위치를 기준으로 선택해야 한다.


## 정리
단방향을 잘이용해서 매핑하는것이 중요하다.